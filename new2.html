<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مقياس البيانات البيومترية</title>
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="chart.js"></script>
    <script defer src="script.js"></script>
    <!-- face-api.js -->
    <script defer src="face-api.min.js"></script>
    <style>
        body {
            background-color: #e8f5e9; /* لون خلفية هادئ */
            color: #333;
        }
        .biometric-section {
            text-align: center;
            margin-top: 50px;
        }
        .video-frame {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .biometric-button {
            margin-top: 20px;
        }
        .biometric-data {
            margin-top: 30px;
            padding: 20px;
            background-color: #e9f7f2;
            border-radius: 15px;
        }
        #chartContainer {
            width: 80%;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <div class="container biometric-section">
        <h2>مقياس البيانات البيومترية</h2>
        <p>قم بتمكين الكاميرا لقياس تأثير الكوارث البيئية على صحتك.</p>

        <!-- Video section -->
        <div class="embed-responsive embed-responsive-16by9 video-frame">
            <iframe class="embed-responsive-item" src="videos/video.mp4" allowfullscreen></iframe>
        </div>

        <!-- Button to request biometric data -->
        <button class="btn btn-primary biometric-button" onclick="startBiometricMeasurement()">ابدأ القياس</button>

        <!-- Placeholder for displaying biometric data -->
        <div id="biometricData" class="biometric-data d-none">
            <h4>البيانات البيومترية الخاصة بك:</h4>
            <!-- <canvas id="biometricChart"></canvas> -->
            <p><strong>معدل ضربات القلب:</strong> <span id="heartRate">--</span> نبضة في الدقيقة</p>
            <p><strong>مستوى التوتر:</strong> <span id="stressLevel">--</span></p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript to handle biometric data collection and chart rendering -->
    <script>
        // تحميل النماذج المطلوبة لـ face-api.js
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('models'),
            faceapi.nets.faceExpressionNet.loadFromUri('models')
        ]).then(() => {
            console.log('face-api.js models loaded');
        });

       

        async function loadModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceExpressionNet.loadFromUri('/models');
        }
        
        loadModels().then(() => {
            startBiometricMeasurement();
        });
        // بدء عملية القياس البيومتري

        async function startBiometricMeasurement() {
            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
        
                // Display the video in the biometric data section
                const biometricDataDiv = document.getElementById('biometricData');
                biometricDataDiv.classList.remove('d-none');
                biometricDataDiv.prepend(video);
                video.style.display = 'block'; // Show video for debugging (can be hidden)
        
                // Load face-api.js models
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('/models');
        
                // Start face detection
                video.addEventListener('play', async () => {
                    const canvas = faceapi.createCanvasFromMedia(video);
                    document.body.append(canvas);
        
                    const displaySize = { width: video.width, height: video.height };
                    faceapi.matchDimensions(canvas, displaySize);
        
                    // Continuously detect face expressions every 3 seconds
                    setInterval(async () => {
                        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
        
                        if (detections.length > 0) {
                            const expressions = detections[0].expressions;
                            const maxExpression = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
        
                            // Simulated biometric data based on facial expression
                            let heartRate = 70;  // Default heart rate
                            let stressLevel = 0; // Default stress level
        
                            if (maxExpression === 'angry' || maxExpression === 'fearful' || maxExpression === 'sad') {
                                heartRate = 90; // Increased heart rate
                                stressLevel = 80; // High stress level
                            } else if (maxExpression === 'happy' || maxExpression === 'surprised') {
                                heartRate = 75; // Moderate heart rate
                                stressLevel = 30; // Low stress level
                            } else {
                                heartRate = 70; // Normal heart rate
                                stressLevel = 50; // Moderate stress level
                            }
        
                            document.getElementById('heartRate').textContent = heartRate;
                            document.getElementById('stressLevel').textContent = stressLevel;
                            document.getElementById('biometricData').classList.remove('d-none');
                            // Update chart with the biometric data
                            const currentTime = new Date().toLocaleTimeString();
                            biometricChart.data.labels.push(currentTime);
                            biometricChart.data.datasets[0].data.push(heartRate);
                            biometricChart.data.datasets[1].data.push(stressLevel);
                            biometricChart.update();
                        }
                        else{
                            let heartRate = 70;  // Default heart rate
                            let stressLevel = 0; 
                            document.getElementById('heartRate').textContent = heartRate;
                            document.getElementById('stressLevel').textContent = stressLevel;
                        }
                    }, 3000); // Run every 3 seconds
                });
        
            } catch (err) {
                console.error('Error accessing the camera: ', err);
                alert('Unable to access the camera. Please make sure you have granted permission.');
            }
        }
        
    </script>

</body>
</html>
